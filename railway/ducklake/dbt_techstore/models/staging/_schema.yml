version: 2

models:
  - name: stg_clientes
    description: "Clientes activos con flag de email duplicado"
    columns:
      - name: cliente_id
        tests: [not_null, unique]
      - name: email
        tests: [not_null]

  - name: stg_productos
    description: "Productos con margen calculado"
    columns:
      - name: producto_id
        tests: [not_null, unique]

  - name: stg_pedidos
    description: "Pedidos con fecha casteada"
    columns:
      - name: pedido_id
        tests: [not_null, unique]
      - name: cliente_id
        tests:
          - not_null
          - relationships:
              to: ref('stg_clientes')
              field: cliente_id
      - name: fecha
        tests: [not_null]
      - name: estado
        tests:
          - not_null
          - accepted_values:
              values: ['pendiente', 'enviado', 'entregado', 'cancelado']
              severity: warn   # warn porque los valores exactos dependen de la fuente
      - name: total
        tests: [not_null]

  - name: stg_detalle_pedidos
    description: "Detalle de pedidos (qty > 0)"
    columns:
      - name: detalle_id
        tests: [not_null, unique]
      - name: pedido_id
        tests:
          - not_null
          - relationships:
              to: ref('stg_pedidos')
              field: pedido_id
      - name: producto_id
        tests:
          - not_null
          - relationships:
              to: ref('stg_productos')
              field: producto_id
      - name: cantidad
        tests: [not_null]
      - name: precio_unitario
        tests: [not_null]
      - name: subtotal
        tests: [not_null]

  - name: stg_envios
    description: "Envios de couriers"
    columns:
      - name: envio_id
        tests: [not_null]
      - name: pedido_id
        tests:
          - not_null
          - relationships:
              to: ref('stg_pedidos')
              field: pedido_id
      - name: courier
        tests: [not_null]
      - name: estado_actual
        tests:
          - not_null
          - accepted_values:
              values: ['en_camino', 'entregado', 'devuelto', 'pendiente']
              severity: warn

  - name: stg_pagos_banco
    description: "Pagos bancarios con tipos casteados"
    columns:
      - name: pago_id
        tests: [not_null]
      - name: pedido_id
        tests:
          - not_null
          - relationships:
              to: ref('stg_pedidos')
              field: pedido_id
      - name: monto
        tests: [not_null]
      - name: fecha_pago
        tests: [not_null]

  - name: stg_reclamos
    description: "Reclamos de clientes"
    columns:
      - name: reclamo_id
        tests: [not_null]
      - name: pedido_id
        tests:
          - not_null
          - relationships:
              to: ref('stg_pedidos')
              field: pedido_id
      - name: cliente_id
        tests:
          - not_null
          - relationships:
              to: ref('stg_clientes')
              field: cliente_id
      - name: fecha_reclamo
        tests: [not_null]
      - name: prioridad
        tests:
          - not_null
          - accepted_values:
              values: ['alta', 'media', 'baja']

  - name: stg_liquidacion_mp
    description: "Liquidaciones de MercadoPago"
    columns:
      - name: operacion_mp
        tests: [not_null]

  - name: stg_catalogo_proveedor
    description: "Catalogo de productos del proveedor"
    columns:
      - name: codigo
        tests: [not_null]

  - name: stg_proveedores_a
    description: "Productos de proveedores cuyo nombre empieza con 'A'"
    columns:
      - name: codigo
        tests: [not_null, unique]
      - name: proveedor
        tests: [not_null]

  # --- ecomm_parquet: modelos dimensionales y de hechos ---

  - name: stg_canal
    description: "Dimension: canales de venta (VTEX, MercadoLibre, Garbarino)"
    columns:
      - name: canal_id
        tests: [not_null, unique]
      - name: canal
        tests:
          - not_null
          - unique
          - accepted_values:
              values: ['vtex', 'mercadolibre', 'garbarino']

  - name: stg_cliente
    description: "Dimension: clientes unicos por canal extraidos de buyer/clientProfileData/customer"
    columns:
      - name: cliente_id
        tests: [not_null, unique]
      - name: canal
        tests:
          - not_null
          - accepted_values:
              values: ['vtex', 'mercadolibre', 'garbarino']
              severity: warn
      - name: cliente_id_origen
        tests: [not_null]

  - name: stg_ubicacion_geo
    description: "Dimension: ubicaciones geograficas unicas de entrega"
    columns:
      - name: ubicacion_id
        tests: [not_null, unique]

  - name: stg_producto
    description: "Dimension: productos unicos por canal extraidos de arrays de items en pedidos"
    columns:
      - name: producto_id
        tests: [not_null, unique]
      - name: canal
        tests:
          - not_null
          - accepted_values:
              values: ['vtex', 'mercadolibre', 'garbarino']
              severity: warn
      - name: nombre
        tests: [not_null]

  - name: stg_pedido
    description: "Fact: pedidos unificados de las 3 plataformas con surrogate key"
    columns:
      - name: pedido_id
        tests: [not_null, unique]
      - name: orden_id_origen
        tests: [not_null]
      - name: canal_id
        tests:
          - not_null
          - relationships:
              to: ref('stg_canal')
              field: canal_id
      - name: status
        tests: [not_null]
      - name: monto_total
        tests: [not_null]
      - name: fecha_creacion
        tests: [not_null]

  - name: stg_item_pedido
    description: "Fact: lineas de pedido, un registro por producto dentro de cada pedido"
    columns:
      - name: item_pedido_id
        tests: [not_null]
      - name: pedido_id
        tests:
          - not_null
          - relationships:
              to: ref('stg_pedido')
              field: pedido_id
      - name: producto_id_origen
        tests: [not_null]
      - name: cantidad
        tests: [not_null]
      - name: precio_unitario
        tests: [not_null]
      - name: subtotal
        tests: [not_null]

  - name: stg_cliente_pedido
    description: "Bridge: relacion entre clientes y sus pedidos por canal"
    columns:
      - name: cliente_id
        tests: [not_null]
      - name: pedido_id
        tests:
          - not_null
          - relationships:
              to: ref('stg_pedido')
              field: pedido_id
      - name: fecha_pedido
        tests: [not_null]
      - name: monto_total
        tests: [not_null]

  - name: stg_cliente_canal
    description: "Bridge: canales que usa cada cliente con metricas de actividad"
    columns:
      - name: cliente_id
        tests: [not_null]
      - name: canal_id
        tests:
          - not_null
          - relationships:
              to: ref('stg_canal')
              field: canal_id
      - name: total_pedidos
        tests: [not_null]

  - name: stg_cliente_ubicacion_geo
    description: "Bridge: clientes y ubicaciones geograficas de sus entregas"
    columns:
      - name: cliente_id
        tests: [not_null]
      - name: ubicacion_id
        tests:
          - not_null
          - relationships:
              to: ref('stg_ubicacion_geo')
              field: ubicacion_id

  - name: stg_canal_producto
    description: "Bridge: productos vendidos por canal con metricas de revenue y unidades"
    columns:
      - name: canal_id
        tests:
          - not_null
          - relationships:
              to: ref('stg_canal')
              field: canal_id
      - name: producto_id
        tests:
          - not_null
          - relationships:
              to: ref('stg_producto')
              field: producto_id
      - name: total_pedidos
        tests: [not_null]
      - name: revenue_total
        tests: [not_null]
